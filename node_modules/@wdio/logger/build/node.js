"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = getLogger;

require("source-map-support/register");

var _fs = _interopRequireDefault(require("fs"));

var _loglevel = _interopRequireDefault(require("loglevel"));

var _util = _interopRequireDefault(require("util"));

var _chalk = _interopRequireDefault(require("chalk"));

var _loglevelPluginPrefix = _interopRequireDefault(require("loglevel-plugin-prefix"));

var _stripAnsi = _interopRequireDefault(require("strip-ansi"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_LEVEL = 0;
const COLORS = {
  error: 'red',
  warn: 'yellow',
  info: 'cyanBright',
  debug: 'green',
  trace: 'cyan'
};
const SERIALIZERS = [{
  /**
   * display error stack
   */
  matches: err => err instanceof Error,
  serialize: err => err.stack
}, {
  /**
   * color commands blue
   */
  matches: log => log === 'COMMAND',
  serialize: log => _chalk.default.magenta(log)
}, {
  /**
   * color data yellow
   */
  matches: log => log === 'DATA',
  serialize: log => _chalk.default.yellow(log)
}, {
  /**
   * color result cyan
   */
  matches: log => log === 'RESULT',
  serialize: log => _chalk.default.cyan(log)
}];
const loggers = {};
const logCache = new Set();
let logFile;
const originalFactory = _loglevel.default.methodFactory;

_loglevel.default.methodFactory = function (methodName, logLevel, loggerName) {
  const rawMethod = originalFactory(methodName, logLevel, loggerName);
  return (...args) => {
    /**
     * create logFile lazily
     */
    if (!logFile && process.env.WDIO_LOG_PATH) {
      logFile = _fs.default.createWriteStream(process.env.WDIO_LOG_PATH);
    }

    args = args.map(arg => {
      for (const s of SERIALIZERS) {
        if (s.matches(arg)) {
          return s.serialize(arg);
        }
      }

      return arg;
    });
    const logText = (0, _stripAnsi.default)(`${_util.default.format.apply(this, args)}\n`);

    if (logFile) {
      /**
       * empty logging cache if stuff got logged before
       */
      if (logCache.size) {
        logCache.forEach(log => logFile.write(log));
        logCache.clear();
      }

      return logFile.write(logText);
    }

    logCache.add(logText);
    rawMethod(...args);
  };
};

_loglevelPluginPrefix.default.apply(_loglevel.default, {
  template: '%t %l %n:',
  timestampFormatter: date => _chalk.default.gray(date.toISOString()),
  levelFormatter: level => _chalk.default[COLORS[level]](level.toUpperCase()),
  nameFormatter: name => _chalk.default.whiteBright(name || 'global')
});

function getLogger(name) {
  /**
   * check if logger was already initiated
   */
  if (loggers[name]) {
    return loggers[name];
  }

  loggers[name] = _loglevel.default.getLogger(name);
  loggers[name].setLevel(process.env.WDIO_LOG_LEVEL || DEFAULT_LEVEL);
  return loggers[name];
}

getLogger.setLevel = (name, level) => loggers[name].setLevel(level);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ub2RlLmpzIl0sIm5hbWVzIjpbIkRFRkFVTFRfTEVWRUwiLCJDT0xPUlMiLCJlcnJvciIsIndhcm4iLCJpbmZvIiwiZGVidWciLCJ0cmFjZSIsIlNFUklBTElaRVJTIiwibWF0Y2hlcyIsImVyciIsIkVycm9yIiwic2VyaWFsaXplIiwic3RhY2siLCJsb2ciLCJjaGFsayIsIm1hZ2VudGEiLCJ5ZWxsb3ciLCJjeWFuIiwibG9nZ2VycyIsImxvZ0NhY2hlIiwiU2V0IiwibG9nRmlsZSIsIm9yaWdpbmFsRmFjdG9yeSIsIm1ldGhvZEZhY3RvcnkiLCJtZXRob2ROYW1lIiwibG9nTGV2ZWwiLCJsb2dnZXJOYW1lIiwicmF3TWV0aG9kIiwiYXJncyIsInByb2Nlc3MiLCJlbnYiLCJXRElPX0xPR19QQVRIIiwiZnMiLCJjcmVhdGVXcml0ZVN0cmVhbSIsIm1hcCIsImFyZyIsInMiLCJsb2dUZXh0IiwidXRpbCIsImZvcm1hdCIsImFwcGx5Iiwic2l6ZSIsImZvckVhY2giLCJ3cml0ZSIsImNsZWFyIiwiYWRkIiwicHJlZml4IiwidGVtcGxhdGUiLCJ0aW1lc3RhbXBGb3JtYXR0ZXIiLCJkYXRlIiwiZ3JheSIsInRvSVNPU3RyaW5nIiwibGV2ZWxGb3JtYXR0ZXIiLCJsZXZlbCIsInRvVXBwZXJDYXNlIiwibmFtZUZvcm1hdHRlciIsIm5hbWUiLCJ3aGl0ZUJyaWdodCIsImdldExvZ2dlciIsInNldExldmVsIiwiV0RJT19MT0dfTEVWRUwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsYUFBYSxHQUFHLENBQXRCO0FBQ0EsTUFBTUMsTUFBTSxHQUFHO0FBQ1hDLEVBQUFBLEtBQUssRUFBRSxLQURJO0FBRVhDLEVBQUFBLElBQUksRUFBRSxRQUZLO0FBR1hDLEVBQUFBLElBQUksRUFBRSxZQUhLO0FBSVhDLEVBQUFBLEtBQUssRUFBRSxPQUpJO0FBS1hDLEVBQUFBLEtB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RSxXQUFMLEVBQVgsQ0FGaEI7QUFHZEMsRUFBQUEsY0FBYyxFQUFHQyxLQUFELElBQVd2QyxlQUFNYixNQUFNLENBQUNvRCxLQUFELENBQVosRUFBcUJBLEtBQUssQ0FBQ0MsV0FBTixFQUFyQixDQUhiO0FBSWRDLEVBQUFBLGFBQWEsRUFBR0MsSUFBRCxJQUFVMUMsZUFBTTJDLFdBQU4sQ0FBa0JELElBQUksSUFBSSxRQUExQjtBQUpYLENBQWxCOztBQU9lLFNBQVNFLFNBQVQsQ0FBb0JGLElBQXBCLEVBQTBCO0FBQ3JDOzs7QUFHQSxNQUFJdEMsT0FBTyxDQUFDc0MsSUFBRCxDQUFYLEVBQW1CO0FBQ2YsV0FBT3RDLE9BQU8sQ0FBQ3NDLElBQUQsQ0FBZDtBQUNIOztBQUVEdEMsRUFBQUEsT0FBTyxDQUFDc0MsSUFBRCxDQUFQLEdBQWdCM0Msa0JBQUk2QyxTQUFKLENBQWNGLElBQWQsQ0FBaEI7QUFDQXRDLEVBQUFBLE9BQU8sQ0FBQ3NDLElBQUQsQ0FBUCxDQUFjRyxRQUFkLENBQXVCOUIsT0FBTyxDQUFDQyxHQUFSLENBQVk4QixjQUFaLElBQThCNUQsYUFBckQ7QUFDQSxTQUFPa0IsT0FBTyxDQUFDc0MsSUFBRCxDQUFkO0FBQ0g7O0FBRURFLFNBQVMsQ0FBQ0MsUUFBVixHQUFxQixDQUFDSCxJQUFELEVBQU9ILEtBQVAsS0FBaUJuQyxPQUFPLENBQUNzQyxJQUFELENBQVAsQ0FBY0csUUFBZCxDQUF1Qk4sS0FBdkIsQ0FBdEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnXG5pbXBvcnQgbG9nIGZyb20gJ2xvZ2xldmVsJ1xuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCdcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsaydcbmltcG9ydCBwcmVmaXggZnJvbSAnbG9nbGV2ZWwtcGx1Z2luLXByZWZpeCdcbmltcG9ydCBhbnNpU3RyaXAgZnJvbSAnc3RyaXAtYW5zaSdcblxuY29uc3QgREVGQVVMVF9MRVZFTCA9IDBcbmNvbnN0IENPTE9SUyA9IHtcbiAgICBlcnJvcjogJ3JlZCcsXG4gICAgd2FybjogJ3llbGxvdycsXG4gICAgaW5mbzogJ2N5YW5CcmlnaHQnLFxuICAgIGRlYnVnOiAnZ3JlZW4nLFxuICAgIHRyYWNlOiAnY3lhbidcbn1cblxuY29uc3QgU0VSSUFMSVpFUlMgPSBbe1xuICAgIC8qKlxuICAgICAqIGRpc3BsYXkgZXJyb3Igc3RhY2tcbiAgICAgKi9cbiAgICBtYXRjaGVzOiAoZXJyKSA9PiBlcnIgaW5zdGFuY2VvZiBFcnJvcixcbiAgICBzZXJpYWxpemU6IChlcnIpID0+IGVyci5zdGFja1xufSwge1xuICAgIC8qKlxuICAgICAqIGNvbG9yIGNvbW1hbmRzIGJsdWVcbiAgICAgKi9cbiAgICBtYXRjaGVzOiAobG9nKSA9PiBsb2cgPT09ICdDT01NQU5EJyxcbiAgICBzZXJpYWxpemU6IChsb2cpID0+IGNoYWxrLm1hZ2VudGEobG9nKVxufSwge1xuICAgIC8qKlxuICAgICAqIGNvbG9yIGRhdGEgeWVsbG93XG4gICAgICovXG4gICAgbWF0Y2hlczogKGxvZykgPT4gbG9nID09PSAnREFUQScsXG4gICAgc2VyaWFsaXplOiAobG9nKSA9PiBjaGFsay55ZWxsb3cobG9nKVxufSwge1xuICAgIC8qKlxuICAgICAqIGNvbG9yIHJlc3VsdCBjeWFuXG4gICAgICovXG4gICAgbWF0Y2hlczogKGxvZykgPT4gbG9nID09PSAnUkVTVUxUJyxcbiAgICBzZXJpYWxpemU6IChsb2cpID0+IGNoYWxrLmN5YW4obG9nKVxufV1cblxuY29uc3QgbG9nZ2VycyA9IHt9XG5jb25zdCBsb2dDYWNoZSA9IG5ldyBTZXQoKVxubGV0IGxvZ0ZpbGVcblxuY29uc3Qgb3JpZ2luYWxGYWN0b3J5ID0gbG9nLm1ldGhvZEZhY3RvcnlcbmxvZy5tZXRob2RGYWN0b3J5ID0gZnVuY3Rpb24gKG1ldGhvZE5hbWUsIGxvZ0xldmVsLCBsb2dnZXJOYW1lKSB7XG4gICAgY29uc3QgcmF3TWV0aG9kID0gb3JpZ2luYWxGYWN0b3J5KG1ldGhvZE5hbWUsIGxvZ0xldmVsLCBsb2dnZXJOYW1lKVxuICAgIHJldHVybiAoLi4uYXJncykgPT4ge1xuICAgICAgICAvKipcbiAgICAgICAgICogY3JlYXRlIGxvZ0ZpbGUgbGF6aWx5XG4gICAgICAgICAqL1xuICAgICAgICBpZiAoIWxvZ0ZpbGUgJiYgcHJvY2Vzcy5lbnYuV0RJT19MT0dfUEFUSCkge1xuICAgICAgICAgICAgbG9nRmlsZSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHByb2Nlc3MuZW52LldESU9fTE9HX1BBVEgpXG4gICAgICAgIH1cblxuICAgICAgICBhcmdzID0gYXJncy5tYXAoKGFyZykgPT4ge1xuICAgICAgICAgICAgZm9yIChjb25zdCBzIG9mIFNFUklBTElaRVJTKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMubWF0Y2hlcyhhcmcpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzLnNlcmlhbGl6ZShhcmcpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFyZ1xuICAgICAgICB9KVxuXG4gICAgICAgIGNvbnN0IGxvZ1RleHQgPSBhbnNpU3RyaXAoYCR7dXRpbC5mb3JtYXQuYXBwbHkodGhpcywgYXJncyl9XFxuYClcbiAgICAgICAgaWYgKGxvZ0ZpbGUpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogZW1wdHkgbG9nZ2luZyBjYWNoZSBpZiBzdHVmZiBnb3QgbG9nZ2VkIGJlZm9yZVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBpZiAobG9nQ2FjaGUuc2l6ZSkge1xuICAgICAgICAgICAgICAgIGxvZ0NhY2hlLmZvckVhY2goKGxvZykgPT4gbG9nRmlsZS53cml0ZShsb2cpKVxuICAgICAgICAgICAgICAgIGxvZ0NhY2hlLmNsZWFyKClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGxvZ0ZpbGUud3JpdGUobG9nVGV4dClcbiAgICAgICAgfVxuXG4gICAgICAgIGxvZ0NhY2hlLmFkZChsb2dUZXh0KVxuICAgICAgICByYXdNZXRob2QoLi4uYXJncylcbiAgICB9XG59XG5cbnByZWZpeC5hcHBseShsb2csIHtcbiAgICB0ZW1wbGF0ZTogJyV0ICVsICVuOicsXG4gICAgdGltZXN0YW1wRm9ybWF0dGVyOiAoZGF0ZSkgPT4gY2hhbGsuZ3JheShkYXRlLnRvSVNPU3RyaW5nKCkpLFxuICAgIGxldmVsRm9ybWF0dGVyOiAobGV2ZWwpID0+IGNoYWxrW0NPTE9SU1tsZXZlbF1dKGxldmVsLnRvVXBwZXJDYXNlKCkpLFxuICAgIG5hbWVGb3JtYXR0ZXI6IChuYW1lKSA9PiBjaGFsay53aGl0ZUJyaWdodChuYW1lIHx8ICdnbG9iYWwnKVxufSlcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZ2V0TG9nZ2VyIChuYW1lKSB7XG4gICAgLyoqXG4gICAgICogY2hlY2sgaWYgbG9nZ2VyIHdhcyBhbHJlYWR5IGluaXRpYXRlZFxuICAgICAqL1xuICAgIGlmIChsb2dnZXJzW25hbWVdKSB7XG4gICAgICAgIHJldHVybiBsb2dnZXJzW25hbWVdXG4gICAgfVxuXG4gICAgbG9nZ2Vyc1tuYW1lXSA9IGxvZy5nZXRMb2dnZXIobmFtZSlcbiAgICBsb2dnZXJzW25hbWVdLnNldExldmVsKHByb2Nlc3MuZW52LldESU9fTE9HX0xFVkVMIHx8IERFRkFVTFRfTEVWRUwpXG4gICAgcmV0dXJuIGxvZ2dlcnNbbmFtZV1cbn1cblxuZ2V0TG9nZ2VyLnNldExldmVsID0gKG5hbWUsIGxldmVsKSA9PiBsb2dnZXJzW25hbWVdLnNldExldmVsKGxldmVsKVxuIl19