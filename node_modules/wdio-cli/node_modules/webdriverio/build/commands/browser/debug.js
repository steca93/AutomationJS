"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = debug;

require("source-map-support/register");

var _vm = _interopRequireDefault(require("vm"));

var _repl = _interopRequireDefault(require("repl"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

var _config = require("@wdio/config");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 *
 * This command helps you to debug your integration tests. It stops the running browser and gives
 * you time to jump into it and check the state of your application (e.g. using dev tools).
 * Your terminal transforms into a [REPL](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop)
 * interface that will allow you to try out certain commands, find elements and test actions on
 * them.
 *
 * [![WebdriverIO REPL](http://webdriver.io/images/repl.gif)](http://webdriver.io/images/repl.gif)
 *
 * If you run the WDIO testrunner make sure you increase the timeout property of the test framework
 * you are using (e.g. Mocha or Jasmine) in order to prevent test termination due to a test timeout.
 * Also avoid executing the command with multiple capabilities running at the same time.
 *
 * <iframe width="560" height="315" src="https://www.youtube.com/embed/xWwP-3B_YyE" frameborder="0" allowfullscreen></iframe>
 *
 * <example>
    :debug.js
    it('should demonstrate the debug command', () => {
        $('#input').setValue('FOO')
        browser.debug() // jumping into the browser and change value of #input to 'BAR'
        const value = $('#input').getValue()
        console.log(value) // outputs: "BAR"
    })
 * </example>
 *
 * @alias browser.debug
 * @type utility
 *
 */
function debug(commandTimeout = 5000) {
  const log = (0, _logger.default)('debug');

  _logger.default.setLevel('debug', 1);

  log.debug(`The execution has stopped!`);
  log.debug(`You can now go into the browser or use the command line as REPL`);
  log.debug(`(To exit, press ^C again or type .exit)\n`);
  let commandIsRunning = false;
  /* istanbul ignore next */

  const myEval = (cmd, context, filename, callback) => {
    if (commandIsRunning) {
      return;
    }

    if (cmd === 'browser\n') {
      return callback(null, '[WebdriverIO REPL client]');
    }

    commandIsRunning = true;
    let result;

    if (_config.hasWdioSyncSupport) {
      return (0, _config.runFnInFiberContext)(() => {
        try {
          result = _vm.default.runInThisContext(cmd);
        } catch (e) {
          commandIsRunning = false;
          return callback(e);
        }

        callback(null, result);
        commandIsRunning = false;
      })();
    }

    context.browser = this;

    try {
      result = _vm.default.runInThisContext(cmd);
    } catch (e) {
      commandIsRunning = false;
      return callback(e);
    }

    if (!result || typeof result.then !== 'function') {
      commandIsRunning = false;
      return callback(null, result);
    }

    const timeout = setTimeout(() => callback(new Error('Command execution timed out')), commandTimeout);
    result.then(res => {
      commandIsRunning = false;
      clearTimeout(timeout);
      return callback(null, res);
    }, e => {
      commandIsRunning = false;
      clearTimeout(timeout);
      const commandError = new Error(e.message);
      delete commandError.stack;
      return callback(commandError);
    });
  };

  const replServer = _repl.default.start({
    prompt: '> ',
    eval: myEval,
    input: process.stdin,
    output: process.stdout,
    useGlobal: true,
    ignoreUndefined: true
  });

  return new Promise(resolve => replServer.on('exit', resolve));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tYW5kcy9icm93c2VyL2RlYnVnLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwiY29tbWFuZFRpbWVvdXQiLCJsb2ciLCJsb2dnZXIiLCJzZXRMZXZlbCIsImNvbW1hbmRJc1J1bm5pbmciLCJteUV2YWwiLCJjbWQiLCJjb250ZXh0IiwiZmlsZW5hbWUiLCJjYWxsYmFjayIsInJlc3VsdCIsImhhc1dkaW9TeW5jU3VwcG9ydCIsInZtIiwicnVuSW5UaGlzQ29udGV4dCIsImUiLCJicm93c2VyIiwidGhlbiIsInRpbWVvdXQiLCJzZXRUaW1lb3V0IiwiRXJyb3IiLCJyZXMiLCJjbGVhclRpbWVvdXQiLCJjb21tYW5kRXJyb3IiLCJtZXNzYWdlIiwic3RhY2siLCJyZXBsU2VydmVyIiwicmVwbCIsInN0YXJ0IiwicHJvbXB0IiwiZXZhbCIsImlucHV0IiwicHJvY2VzcyIsInN0ZGluIiwib3V0cHV0Iiwic3Rkb3V0IiwidXNlR2xvYmFsIiwiaWdub3JlVW5kZWZpbmVkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBZ0NBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBbkNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFxQ2UsU0FBU0EsS0FBVCxDQUFlQyxjQUFjLEdBQUcsSUFBaEMsRUFBc0M7QUFDakQsUUFBTUMsR0FBRyxHQUFHLHFCQUFPLE9BQVAsQ0FBWjs7QUFDQUMsa0JBQU9DLFFBQVAsQ0FBZ0IsT0FBaEIsRUFBeUIsQ0FBekI7O0FBRUFGLEVBQUFBLEdBQUcsQ0FBQ0YsS0FBSixDQUFXLDRCQUFYO0FBQ0FFLEVBQUFBLEdBQUcsQ0FBQ0YsS0FBSixDQUFXLGlFQUFYO0FBQ0FFLEVBQUFBLEdBQUcsQ0FBQ0YsS0FBSixDQUFXLDJDQUFYO0FBRUEsTUFBSUssZ0JBQWdCLEdBQUcsS0FBdkI7QUFFQTs7QUFDQSxRQUFNQyxNQUFNLEdBQUcsQ0FBQ0MsR0FBRCxFQUFNQyxPQUFOLEVBQWVDLFFBQWYsRUFBeUJDLFFBQXpCLEtBQXNDO0FBQ2pELFFBQUlMLGdCQUFKLEVBQXNCO0FBQ2xCO0FBQ0g7O0FBRUQsUUFBSUUsR0FBRyxLQUFLLFdBQVosRUFBeUI7QUFDckIsYUFBT0csUUFBUSxDQUFDLElBQUQsRUFBTywyQkFBUCxDQUFmO0FBQ0g7O0FBRURMLElBQUFBLGdCQUFnQixHQUFHLElBQW5CO0FBQ0EsUUFBSU0sTUFBSjs7QUFDQSxRQUFJQywwQkFBSixFQUF3QjtBQUNwQixhQUFPLGlDQUFvQixNQUFNO0FBQzdCLFlBQUk7QUFDQUQsVUFBQUEsTUFBTSxHQUFHRSxZQUFHQyxnQkFBSCxDQUFvQlAsR0FBcEIsQ0FBVDtBQUNILFNBRkQsQ0FFRSxPQUFPUSxDQUFQLEVBQVU7QUFDUlYsVUFBQUEsZ0JBQWdCLEdBQUcsS0FBbkI7QUFDQSxpQkFBT0ssUUFBUSxDQUFDSyxDQUFELENBQWY7QUFDSDs7QUFFREwsUUFBQUEsUUFBUSxDQUFDLElBQUQsRUFBT0MsTUFBUCxDQUFSO0FBQ0FOLFFBQUFBLGdCQUFnQixHQUFHLEtBQW5CO0FBQ0gsT0FWTSxHQUFQO0FBV0g7O0FBRURHLElBQUFBLE9BQU8sQ0FBQ1EsT0FBUixHQUFrQixJQUFsQjs7QUFDQSxRQUFJO0FBQ0FMLE1BQUFBLE1BQU0sR0FBR0UsWUFBR0MsZ0JBQUgsQ0FBb0JQLEdBQXBCLENBQVQ7QUFDSCxLQUZELENBRUUsT0FBT1EsQ0FBUCxFQUFVO0FBQ1JWLE1BQUFBLGdCQUFnQixHQUFHLEtBQW5CO0FBQ0EsYUFBT0ssUUFBUSxDQUFDSyxDQUFELENBQWY7QUFDSDs7QUFFRCxRQUFJLENBQUNKLE1BQUQsSUFBVyxPQUFPQSxNQUFNLENBQUNNLElBQWQsS0FBdUIsVUFBdEMsRUFBa0Q7QUFDOUNaLE1BQUFBLGdCQUFnQixHQUFHLEtBQW5CO0FBQ0EsYUFBT0ssUUFBUSxDQUFDLElBQUQsRUFBT0MsTUFBUCxDQUFmO0FBQ0g7O0FBRUQsVUFBTU8sT0FBTyxHQUFHQyxVQUFVLENBQUMsTUFBTVQsUUFBUSxDQUFDLElBQUlVLEtBQUosQ0FBVSw2QkFBVixDQUFELENBQWYsRUFBMkRuQixjQUEzRCxDQUExQjtBQUNBVSxJQUFBQSxNQUFNLENBQUNNLElBQVAsQ0FBYUksR0FBRCxJQUFTO0FBQ2pCaEIsTUFBQUEsZ0JBQWdCLEdBQUcsS0FBbkI7QUFDQWlCLE1BQUFBLFlBQVksQ0FBQ0osT0FBRCxDQUFaO0FBQ0EsYUFBT1IsUUFBUSxDQUFDLElBQUQsRUFBT1csR0FBUCxDQUFmO0FBQ0gsS0FKRCxFQUlJTixDQUFELElBQU87QUFDTlYsTUFBQUEsZ0JBQWdCLEdBQUcsS0FBbkI7QUFDQWlCLE1BQUFBLFlBQVksQ0FBQ0osT0FBRCxDQUFaO0FBQ0EsWUFBTUssWUFBWSxHQUFHLElBQUlILEtBQUosQ0FBVUwsQ0FBQyxDQUFDUyxPQUFaLENBQXJCO0FBQ0EsYUFBT0QsWUFBWSxDQUFDRSxLQUFwQjtBQUNBLGFBQU9mLFFBQVEsQ0FBQ2EsWUFBRCxDQUFmO0FBQ0gsS0FWRDtBQVdILEdBbEREOztBQW9EQSxRQUFNRyxVQUFVLEdBQUdDLGNBQUtDLEtBQUwsQ0FBVztBQUMxQkMsSUFBQUEsTUFBTSxFQUFFLElBRGtCO0FBRTFCQyxJQUFBQSxJQUFJLEVBQUV4QixNQUZvQjtBQUcxQnlCLElBQUFBLEtBQUssRUFBRUMsT0FBTyxDQUFDQyxLQUhXO0FBSTFCQyxJQUFBQSxNQUFNLEVBQUVGLE9BQU8sQ0FBQ0csTUFKVTtBQUsxQkMsSUFBQUEsU0FBUyxFQUFFLElBTGU7QUFNMUJDLElBQUFBLGVBQWUsRUFBRTtBQU5TLEdBQVgsQ0FBbkI7O0FBU0EsU0FBTyxJQUFJQyxPQUFKLENBQWFDLE9BQUQsSUFBYWIsVUFBVSxDQUFDYyxFQUFYLENBQWMsTUFBZCxFQUFzQkQsT0FBdEIsQ0FBekIsQ0FBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiXG4vKipcbiAqXG4gKiBUaGlzIGNvbW1hbmQgaGVscHMgeW91IHRvIGRlYnVnIHlvdXIgaW50ZWdyYXRpb24gdGVzdHMuIEl0IHN0b3BzIHRoZSBydW5uaW5nIGJyb3dzZXIgYW5kIGdpdmVzXG4gKiB5b3UgdGltZSB0byBqdW1wIGludG8gaXQgYW5kIGNoZWNrIHRoZSBzdGF0ZSBvZiB5b3VyIGFwcGxpY2F0aW9uIChlLmcuIHVzaW5nIGRldiB0b29scykuXG4gKiBZb3VyIHRlcm1pbmFsIHRyYW5zZm9ybXMgaW50byBhIFtSRVBMXShodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9SZWFkJUUyJTgwJTkzZXZhbCVFMiU4MCU5M3ByaW50X2xvb3ApXG4gKiBpbnRlcmZhY2UgdGhhdCB3aWxsIGFsbG93IHlvdSB0byB0cnkgb3V0IGNlcnRhaW4gY29tbWFuZHMsIGZpbmQgZWxlbWVudHMgYW5kIHRlc3QgYWN0aW9ucyBvblxuICogdGhlbS5cbiAqXG4gKiBbIVtXZWJkcml2ZXJJTyBSRVBMXShodHRwOi8vd2ViZHJpdmVyLmlvL2ltYWdlcy9yZXBsLmdpZildKGh0dHA6Ly93ZWJkcml2ZXIuaW8vaW1hZ2VzL3JlcGwuZ2lmKVxuICpcbiAqIElmIHlvdSBydW4gdGhlIFdESU8gdGVzdHJ1bm5lciBtYWtlIHN1cmUgeW91IGluY3JlYXNlIHRoZSB0aW1lb3V0IHByb3BlcnR5IG9mIHRoZSB0ZXN0IGZyYW1ld29ya1xuICogeW91IGFyZSB1c2luZyAoZS5nLiBNb2NoYSBvciBKYXNtaW5lKSBpbiBvcmRlciB0byBwcmV2ZW50IHRlc3QgdGVybWluYXRpb24gZHVlIHRvIGEgdGVzdCB0aW1lb3V0LlxuICogQWxzbyBhdm9pZCBleGVjdXRpbmcgdGhlIGNvbW1hbmQgd2l0aCBtdWx0aXBsZSBjYXBhYmlsaXRpZXMgcnVubmluZyBhdCB0aGUgc2FtZSB0aW1lLlxuICpcbiAqIDxpZnJhbWUgd2lkdGg9XCI1NjBcIiBoZWlnaHQ9XCIzMTVcIiBzcmM9XCJodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC94V3dQLTNCX1l5RVwiIGZyYW1lYm9yZGVyPVwiMFwiIGFsbG93ZnVsbHNjcmVlbj48L2lmcmFtZT5cbiAqXG4gKiA8ZXhhbXBsZT5cbiAgICA6ZGVidWcuanNcbiAgICBpdCgnc2hvdWxkIGRlbW9uc3RyYXRlIHRoZSBkZWJ1ZyBjb21tYW5kJywgKCkgPT4ge1xuICAgICAgICAkKCcjaW5wdXQnKS5zZXRWYWx1ZSgnRk9PJylcbiAgICAgICAgYnJvd3Nlci5kZWJ1ZygpIC8vIGp1bXBpbmcgaW50byB0aGUgYnJvd3NlciBhbmQgY2hhbmdlIHZhbHVlIG9mICNpbnB1dCB0byAnQkFSJ1xuICAgICAgICBjb25zdCB2YWx1ZSA9ICQoJyNpbnB1dCcpLmdldFZhbHVlKClcbiAgICAgICAgY29uc29sZS5sb2codmFsdWUpIC8vIG91dHB1dHM6IFwiQkFSXCJcbiAgICB9KVxuICogPC9leGFtcGxlPlxuICpcbiAqIEBhbGlhcyBicm93c2VyLmRlYnVnXG4gKiBAdHlwZSB1dGlsaXR5XG4gKlxuICovXG5cbmltcG9ydCB2bSBmcm9tICd2bSdcbmltcG9ydCByZXBsIGZyb20gJ3JlcGwnXG5cbmltcG9ydCBsb2dnZXIgZnJvbSAnQHdkaW8vbG9nZ2VyJ1xuaW1wb3J0IHsgcnVuRm5JbkZpYmVyQ29udGV4dCwgaGFzV2Rpb1N5bmNTdXBwb3J0IH0gZnJvbSAnQHdkaW8vY29uZmlnJ1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBkZWJ1Zyhjb21tYW5kVGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCBsb2cgPSBsb2dnZXIoJ2RlYnVnJylcbiAgICBsb2dnZXIuc2V0TGV2ZWwoJ2RlYnVnJywgMSlcblxuICAgIGxvZy5kZWJ1ZyhgVGhlIGV4ZWN1dGlvbiBoYXMgc3RvcHBlZCFgKVxuICAgIGxvZy5kZWJ1ZyhgWW91IGNhbiBub3cgZ28gaW50byB0aGUgYnJvd3NlciBvciB1c2UgdGhlIGNvbW1hbmQgbGluZSBhcyBSRVBMYClcbiAgICBsb2cuZGVidWcoYChUbyBleGl0LCBwcmVzcyBeQyBhZ2FpbiBvciB0eXBlIC5leGl0KVxcbmApXG5cbiAgICBsZXQgY29tbWFuZElzUnVubmluZyA9IGZhbHNlXG5cbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIGNvbnN0IG15RXZhbCA9IChjbWQsIGNvbnRleHQsIGZpbGVuYW1lLCBjYWxsYmFjaykgPT4ge1xuICAgICAgICBpZiAoY29tbWFuZElzUnVubmluZykge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY21kID09PSAnYnJvd3NlclxcbicpIHtcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCAnW1dlYmRyaXZlcklPIFJFUEwgY2xpZW50XScpXG4gICAgICAgIH1cblxuICAgICAgICBjb21tYW5kSXNSdW5uaW5nID0gdHJ1ZVxuICAgICAgICBsZXQgcmVzdWx0XG4gICAgICAgIGlmIChoYXNXZGlvU3luY1N1cHBvcnQpIHtcbiAgICAgICAgICAgIHJldHVybiBydW5GbkluRmliZXJDb250ZXh0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB2bS5ydW5JblRoaXNDb250ZXh0KGNtZClcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbW1hbmRJc1J1bm5pbmcgPSBmYWxzZVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHQpXG4gICAgICAgICAgICAgICAgY29tbWFuZElzUnVubmluZyA9IGZhbHNlXG4gICAgICAgICAgICB9KSgpXG4gICAgICAgIH1cblxuICAgICAgICBjb250ZXh0LmJyb3dzZXIgPSB0aGlzXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXN1bHQgPSB2bS5ydW5JblRoaXNDb250ZXh0KGNtZClcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29tbWFuZElzUnVubmluZyA9IGZhbHNlXG4gICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZSlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcmVzdWx0IHx8IHR5cGVvZiByZXN1bHQudGhlbiAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgY29tbWFuZElzUnVubmluZyA9IGZhbHNlXG4gICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgcmVzdWx0KVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gY2FsbGJhY2sobmV3IEVycm9yKCdDb21tYW5kIGV4ZWN1dGlvbiB0aW1lZCBvdXQnKSksIGNvbW1hbmRUaW1lb3V0KVxuICAgICAgICByZXN1bHQudGhlbigocmVzKSA9PiB7XG4gICAgICAgICAgICBjb21tYW5kSXNSdW5uaW5nID0gZmFsc2VcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KVxuICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHJlcylcbiAgICAgICAgfSwgKGUpID0+IHtcbiAgICAgICAgICAgIGNvbW1hbmRJc1J1bm5pbmcgPSBmYWxzZVxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpXG4gICAgICAgICAgICBjb25zdCBjb21tYW5kRXJyb3IgPSBuZXcgRXJyb3IoZS5tZXNzYWdlKVxuICAgICAgICAgICAgZGVsZXRlIGNvbW1hbmRFcnJvci5zdGFja1xuICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGNvbW1hbmRFcnJvcilcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCByZXBsU2VydmVyID0gcmVwbC5zdGFydCh7XG4gICAgICAgIHByb21wdDogJz4gJyxcbiAgICAgICAgZXZhbDogbXlFdmFsLFxuICAgICAgICBpbnB1dDogcHJvY2Vzcy5zdGRpbixcbiAgICAgICAgb3V0cHV0OiBwcm9jZXNzLnN0ZG91dCxcbiAgICAgICAgdXNlR2xvYmFsOiB0cnVlLFxuICAgICAgICBpZ25vcmVVbmRlZmluZWQ6IHRydWVcbiAgICB9KVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiByZXBsU2VydmVyLm9uKCdleGl0JywgcmVzb2x2ZSkpXG59XG4iXX0=