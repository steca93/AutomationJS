"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _config = require("@wdio/config");

const TIMEOUT_ERROR = 'timeout';
/**
 * Promise-based Timer. Execute fn every tick.
 * When fn is resolved â€” timer will stop
 * @param {Number} delay - delay between ticks
 * @param {Number} timeout - after that time timer will stop
 * @param {Function} fn - function that returns promise. will execute every tick
 * @param {Boolean} leading - should be function invoked on start
 * @return {promise} Promise-based Timer.
 */

class Timer {
  constructor(delay, timeout, fn, leading) {
    this._delay = delay;
    this._timeout = timeout;
    this._fn = fn;
    this._leading = leading;
    this._conditionExecutedCnt = 0;
    /**
     * only wrap waitUntil condition if:
     *  - wdio-sync is installed
     *  - function name is not async
     */

    if (_config.hasWdioSyncSupport && !fn.name.includes('async')) {
      this._fn = () => new Promise(resolve => (0, _config.runFnInFiberContext)(fn, resolve)());
    }

    const retPromise = new Promise((resolve, reject) => {
      this._resolve = resolve;
      this._reject = reject;
    });
    this.start();
    return retPromise;
  }

  start() {
    this._start = Date.now();
    this._ticks = 0;

    if (this._leading) {
      this.tick();
    } else {
      this._timeoutId = setTimeout(this.tick.bind(this), this._delay);
    }

    this._mainTimeoutId = setTimeout(() => {
      /**
       * make sure that condition was executed at least once
       */
      if (!this.wasConditionExecuted()) {
        return;
      }

      const reason = this.lastError || new Error(TIMEOUT_ERROR);

      this._reject(reason);

      this.stop();
    }, this._timeout);
  }

  stop() {
    if (this._timeoutId) {
      clearTimeout(this._timeoutId);
    }

    this._timeoutId = null;
  }

  stopMain() {
    clearTimeout(this._mainTimeoutId);
  }

  tick() {
    const result = this._fn();

    if (typeof result.then !== 'function') {
      if (!result) {
        return this.checkCondition(new Error('return value was never truthy'));
      }

      return this.checkCondition(null, result);
    }

    result.then(res => this.checkCondition(null, res), err => this.checkCondition(err));
  }

  checkCondition(err, res) {
    ++this._conditionExecutedCnt;
    this.lastError = err; // resolve timer only on truthy values

    if (res) {
      this._resolve(res);

      this.stop();
      this.stopMain();
      return;
    } // autocorrect timer


    let diff = Date.now() - this._start - this._ticks++ * this._delay;

    let delay = Math.max(0, this._delay - diff); // clear old timeoutID

    this.stop(); // check if we have time to one more tick

    if (this.hasTime(delay)) {
      this._timeoutId = setTimeout(this.tick.bind(this), delay);
    } else {
      this.stopMain();
      const reason = this.lastError || new Error(TIMEOUT_ERROR);

      this._reject(reason);
    }
  }

  hasTime(delay) {
    return Date.now() - this._start + delay <= this._timeout;
  }

  wasConditionExecuted() {
    return this._conditionExecutedCnt > 0;
  }

}

var _default = Timer;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9UaW1lci5qcyJdLCJuYW1lcyI6WyJUSU1FT1VUX0VSUk9SIiwiVGltZXIiLCJjb25zdHJ1Y3RvciIsImRlbGF5IiwidGltZW91dCIsImZuIiwibGVhZGluZyIsIl9kZWxheSIsIl90aW1lb3V0IiwiX2ZuIiwiX2xlYWRpbmciLCJfY29uZGl0aW9uRXhlY3V0ZWRDbnQiLCJoYXNXZGlvU3luY1N1cHBvcnQiLCJuYW1lIiwiaW5jbHVkZXMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJldFByb21pc2UiLCJyZWplY3QiLCJfcmVzb2x2ZSIsIl9yZWplY3QiLCJzdGFydCIsIl9zdGFydCIsIkRhdGUiLCJub3ciLCJfdGlja3MiLCJ0aWNrIiwiX3RpbWVvdXRJZCIsInNldFRpbWVvdXQiLCJiaW5kIiwiX21haW5UaW1lb3V0SWQiLCJ3YXNDb25kaXRpb25FeGVjdXRlZCIsInJlYXNvbiIsImxhc3RFcnJvciIsIkVycm9yIiwic3RvcCIsImNsZWFyVGltZW91dCIsInN0b3BNYWluIiwicmVzdWx0IiwidGhlbiIsImNoZWNrQ29uZGl0aW9uIiwicmVzIiwiZXJyIiwiZGlmZiIsIk1hdGgiLCJtYXgiLCJoYXNUaW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFFQSxNQUFNQSxhQUFhLEdBQUcsU0FBdEI7QUFFQTs7Ozs7Ozs7OztBQVNBLE1BQU1DLEtBQU4sQ0FBWTtBQUNSQyxFQUFBQSxXQUFXLENBQUVDLEtBQUYsRUFBU0MsT0FBVCxFQUFrQkMsRUFBbEIsRUFBc0JDLE9BQXRCLEVBQStCO0FBQ3RDLFNBQUtDLE1BQUwsR0FBY0osS0FBZDtBQUNBLFNBQUtLLFFBQUwsR0FBZ0JKLE9BQWhCO0FBQ0EsU0FBS0ssR0FBTCxHQUFXSixFQUFYO0FBQ0EsU0FBS0ssUUFBTCxHQUFnQkosT0FBaEI7QUFDQSxTQUFLSyxxQkFBTCxHQUE2QixDQUE3QjtBQUVBOzs7Ozs7QUFLQSxRQUFJQyw4QkFBc0IsQ0FBQ1AsRUFBRSxDQUFDUSxJQUFILENBQVFDLFFBQVIsQ0FBaUIsT0FBakIsQ0FBM0IsRUFBc0Q7QUFDbEQsV0FBS0wsR0FBTCxHQUFXLE1BQU0sSUFBSU0sT0FBSixDQUFhQyxPQUFELElBQWEsaUNBQW9CWCxFQUFwQixFQUF3QlcsT0FBeEIsR0FBekIsQ0FBakI7QUFDSDs7QUFFRCxVQUFNQyxVQUFVLEdBQUcsSUFBSUYsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUUsTUFBVixLQUFxQjtBQUNoRCxXQUFLQyxRQUFMLEdBQWdCSCxPQUFoQjtBQUNBLFdBQUtJLE9BQUwsR0FBZUYsTUFBZjtBQUNILEtBSGtCLENBQW5CO0FBS0EsU0FBS0csS0FBTDtBQUVBLFdBQU9KLFVBQVA7QUFDSDs7QUFFREksRUFBQUEsS0FBSyxHQUFJO0FBQ0wsU0FBS0MsTUFBTCxHQUFjQyxJQUFJLENBQUNDLEdBQUwsRUFBZDtBQUNBLFNBQUtDLE1BQUwsR0FBYyxDQUFkOztBQUNBLFFBQUksS0FBS2YsUUFBVCxFQUFtQjtBQUNmLFdBQUtnQixJQUFMO0FBQ0gsS0FGRCxNQUVPO0FBQ0gsV0FBS0MsVUFBTCxHQUFrQkMsVUFBVSxDQUFDLEtBQUtGLElBQUwsQ0FBVUcsSUFBVixDQUFlLElBQWYsQ0FBRCxFQUF1QixLQUFLdEIsTUFBNUIsQ0FBNUI7QUFDSDs7QUFFRCxTQUFLdUIsY0FBTCxHQUFzQkYsVUFBVSxDQUFDLE1BQU07QUFDbkM7OztBQUdBLFVBQUksQ0FBQyxLQUFLRyxvQkFBTCxFQUFMLEVBQWtDO0FBQzlCO0FBQ0g7O0FBRUQsWUFBTUMsTUFBTSxHQUFHLEtBQUtDLFNBQUwsSUFBa0IsSUFBSUMsS0FBSixDQUFVbEMsYUFBVixDQUFqQzs7QUFDQSxXQUFLb0IsT0FBTCxDQUFhWSxNQUFiOztBQUNBLFdBQUtHLElBQUw7QUFDSCxLQVgrQixFQVc3QixLQUFLM0IsUUFYd0IsQ0FBaEM7QUFZSDs7QUFFRDJCLEVBQUFBLElBQUksR0FBSTtBQUNKLFFBQUksS0FBS1IsVUFBVCxFQUFxQjtBQUNqQlMsTUFBQUEsWUFBWSxDQUFDLEtBQUtULFVBQU4sQ0FBWjtBQUNIOztBQUNELFNBQUtBLFVBQUwsR0FBa0IsSUFBbEI7QUFDSDs7QUFFRFUsRUFBQUEsUUFBUSxHQUFJO0FBQ1JELElBQUFBLFlBQVksQ0FBQyxLQUFLTixjQUFOLENBQVo7QUFDSDs7QUFFREosRUFBQUEsSUFBSSxHQUFJO0FBQ0osVUFBTVksTUFBTSxHQUFHLEtBQUs3QixHQUFMLEVBQWY7O0FBRUEsUUFBSSxPQUFPNkIsTUFBTSxDQUFDQyxJQUFkLEtBQXVCLFVBQTNCLEVBQXVDO0FBQ25DLFVBQUksQ0FBQ0QsTUFBTCxFQUFhO0FBQ1QsZUFBTyxLQUFLRSxjQUFMLENBQW9CLElBQUlOLEtBQUosQ0FBVSwrQkFBVixDQUFwQixDQUFQO0FBQ0g7O0FBRUQsYUFBTyxLQUFLTSxjQUFMLENBQW9CLElBQXBCLEVBQTBCRixNQUExQixDQUFQO0FBQ0g7O0FBRURBLElBQUFBLE1BQU0sQ0FBQ0MsSUFBUCxDQUNLRSxHQUFELElBQVMsS0FBS0QsY0FBTCxDQUFvQixJQUFwQixFQUEwQkMsR0FBMUIsQ0FEYixFQUVLQyxHQUFELElBQVMsS0FBS0YsY0FBTCxDQUFvQkUsR0FBcEIsQ0FGYjtBQUlIOztBQUVERixFQUFBQSxjQUFjLENBQUVFLEdBQUYsRUFBT0QsR0FBUCxFQUFZO0FBQ3RCLE1BQUUsS0FBSzlCLHFCQUFQO0FBQ0EsU0FBS3NCLFNBQUwsR0FBaUJTLEdBQWpCLENBRnNCLENBSXRCOztBQUNBLFFBQUlELEdBQUosRUFBUztBQUNMLFdBQUt0QixRQUFMLENBQWNzQixHQUFkOztBQUNBLFdBQUtOLElBQUw7QUFDQSxXQUFLRSxRQUFMO0FBQ0E7QUFDSCxLQVZxQixDQVl0Qjs7O0FBQ0EsUUFBSU0sSUFBSSxHQUFJcEIsSUFBSSxDQUFDQyxHQUFMLEtBQWEsS0FBS0YsTUFBbkIsR0FBOEIsS0FBS0csTUFBTCxLQUFnQixLQUFLbEIsTUFBOUQ7O0FBQ0EsUUFBSUosS0FBSyxHQUFHeUMsSUFBSSxDQUFDQyxHQUFMLENBQVMsQ0FBVCxFQUFZLEtBQUt0QyxNQUFMLEdBQWNvQyxJQUExQixDQUFaLENBZHNCLENBZ0J0Qjs7QUFDQSxTQUFLUixJQUFMLEdBakJzQixDQW1CdEI7O0FBQ0EsUUFBSSxLQUFLVyxPQUFMLENBQWEzQyxLQUFiLENBQUosRUFBeUI7QUFDckIsV0FBS3dCLFVBQUwsR0FBa0JDLFVBQVUsQ0FBQyxLQUFLRixJQUFMLENBQVVHLElBQVYsQ0FBZSxJQUFmLENBQUQsRUFBdUIxQixLQUF2QixDQUE1QjtBQUNILEtBRkQsTUFFTztBQUNILFdBQUtrQyxRQUFMO0FBQ0EsWUFBTUwsTUFBTSxHQUFHLEtBQUtDLFNBQUwsSUFBa0IsSUFBSUMsS0FBSixDQUFVbEMsYUFBVixDQUFqQzs7QUFDQSxXQUFLb0IsT0FBTCxDQUFhWSxNQUFiO0FBQ0g7QUFDSjs7QUFFRGMsRUFBQUEsT0FBTyxDQUFFM0MsS0FBRixFQUFTO0FBQ1osV0FBUW9CLElBQUksQ0FBQ0MsR0FBTCxLQUFhLEtBQUtGLE1BQWxCLEdBQTJCbkIsS0FBNUIsSUFBc0MsS0FBS0ssUUFBbEQ7QUFDSDs7QUFFRHVCLEVBQUFBLG9CQUFvQixHQUFJO0FBQ3BCLFdBQU8sS0FBS3BCLHFCQUFMLEdBQTZCLENBQXBDO0FBQ0g7O0FBakhPOztlQW9IR1YsSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGhhc1dkaW9TeW5jU3VwcG9ydCwgcnVuRm5JbkZpYmVyQ29udGV4dCB9IGZyb20gJ0B3ZGlvL2NvbmZpZydcblxuY29uc3QgVElNRU9VVF9FUlJPUiA9ICd0aW1lb3V0J1xuXG4vKipcbiAqIFByb21pc2UtYmFzZWQgVGltZXIuIEV4ZWN1dGUgZm4gZXZlcnkgdGljay5cbiAqIFdoZW4gZm4gaXMgcmVzb2x2ZWQg4oCUIHRpbWVyIHdpbGwgc3RvcFxuICogQHBhcmFtIHtOdW1iZXJ9IGRlbGF5IC0gZGVsYXkgYmV0d2VlbiB0aWNrc1xuICogQHBhcmFtIHtOdW1iZXJ9IHRpbWVvdXQgLSBhZnRlciB0aGF0IHRpbWUgdGltZXIgd2lsbCBzdG9wXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiAtIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBwcm9taXNlLiB3aWxsIGV4ZWN1dGUgZXZlcnkgdGlja1xuICogQHBhcmFtIHtCb29sZWFufSBsZWFkaW5nIC0gc2hvdWxkIGJlIGZ1bmN0aW9uIGludm9rZWQgb24gc3RhcnRcbiAqIEByZXR1cm4ge3Byb21pc2V9IFByb21pc2UtYmFzZWQgVGltZXIuXG4gKi9cbmNsYXNzIFRpbWVyIHtcbiAgICBjb25zdHJ1Y3RvciAoZGVsYXksIHRpbWVvdXQsIGZuLCBsZWFkaW5nKSB7XG4gICAgICAgIHRoaXMuX2RlbGF5ID0gZGVsYXlcbiAgICAgICAgdGhpcy5fdGltZW91dCA9IHRpbWVvdXRcbiAgICAgICAgdGhpcy5fZm4gPSBmblxuICAgICAgICB0aGlzLl9sZWFkaW5nID0gbGVhZGluZ1xuICAgICAgICB0aGlzLl9jb25kaXRpb25FeGVjdXRlZENudCA9IDBcblxuICAgICAgICAvKipcbiAgICAgICAgICogb25seSB3cmFwIHdhaXRVbnRpbCBjb25kaXRpb24gaWY6XG4gICAgICAgICAqICAtIHdkaW8tc3luYyBpcyBpbnN0YWxsZWRcbiAgICAgICAgICogIC0gZnVuY3Rpb24gbmFtZSBpcyBub3QgYXN5bmNcbiAgICAgICAgICovXG4gICAgICAgIGlmIChoYXNXZGlvU3luY1N1cHBvcnQgJiYgIWZuLm5hbWUuaW5jbHVkZXMoJ2FzeW5jJykpIHtcbiAgICAgICAgICAgIHRoaXMuX2ZuID0gKCkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJ1bkZuSW5GaWJlckNvbnRleHQoZm4sIHJlc29sdmUpKCkpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXRQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmVcbiAgICAgICAgICAgIHRoaXMuX3JlamVjdCA9IHJlamVjdFxuICAgICAgICB9KVxuXG4gICAgICAgIHRoaXMuc3RhcnQoKVxuXG4gICAgICAgIHJldHVybiByZXRQcm9taXNlXG4gICAgfVxuXG4gICAgc3RhcnQgKCkge1xuICAgICAgICB0aGlzLl9zdGFydCA9IERhdGUubm93KClcbiAgICAgICAgdGhpcy5fdGlja3MgPSAwXG4gICAgICAgIGlmICh0aGlzLl9sZWFkaW5nKSB7XG4gICAgICAgICAgICB0aGlzLnRpY2soKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fdGltZW91dElkID0gc2V0VGltZW91dCh0aGlzLnRpY2suYmluZCh0aGlzKSwgdGhpcy5fZGVsYXkpXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9tYWluVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIG1ha2Ugc3VyZSB0aGF0IGNvbmRpdGlvbiB3YXMgZXhlY3V0ZWQgYXQgbGVhc3Qgb25jZVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBpZiAoIXRoaXMud2FzQ29uZGl0aW9uRXhlY3V0ZWQoKSkge1xuICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCByZWFzb24gPSB0aGlzLmxhc3RFcnJvciB8fCBuZXcgRXJyb3IoVElNRU9VVF9FUlJPUilcbiAgICAgICAgICAgIHRoaXMuX3JlamVjdChyZWFzb24pXG4gICAgICAgICAgICB0aGlzLnN0b3AoKVxuICAgICAgICB9LCB0aGlzLl90aW1lb3V0KVxuICAgIH1cblxuICAgIHN0b3AgKCkge1xuICAgICAgICBpZiAodGhpcy5fdGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dElkKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3RpbWVvdXRJZCA9IG51bGxcbiAgICB9XG5cbiAgICBzdG9wTWFpbiAoKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9tYWluVGltZW91dElkKVxuICAgIH1cblxuICAgIHRpY2sgKCkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9mbigpXG5cbiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQudGhlbiAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja0NvbmRpdGlvbihuZXcgRXJyb3IoJ3JldHVybiB2YWx1ZSB3YXMgbmV2ZXIgdHJ1dGh5JykpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrQ29uZGl0aW9uKG51bGwsIHJlc3VsdClcbiAgICAgICAgfVxuXG4gICAgICAgIHJlc3VsdC50aGVuKFxuICAgICAgICAgICAgKHJlcykgPT4gdGhpcy5jaGVja0NvbmRpdGlvbihudWxsLCByZXMpLFxuICAgICAgICAgICAgKGVycikgPT4gdGhpcy5jaGVja0NvbmRpdGlvbihlcnIpXG4gICAgICAgIClcbiAgICB9XG5cbiAgICBjaGVja0NvbmRpdGlvbiAoZXJyLCByZXMpIHtcbiAgICAgICAgKyt0aGlzLl9jb25kaXRpb25FeGVjdXRlZENudFxuICAgICAgICB0aGlzLmxhc3RFcnJvciA9IGVyclxuXG4gICAgICAgIC8vIHJlc29sdmUgdGltZXIgb25seSBvbiB0cnV0aHkgdmFsdWVzXG4gICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgIHRoaXMuX3Jlc29sdmUocmVzKVxuICAgICAgICAgICAgdGhpcy5zdG9wKClcbiAgICAgICAgICAgIHRoaXMuc3RvcE1haW4oKVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICAvLyBhdXRvY29ycmVjdCB0aW1lclxuICAgICAgICBsZXQgZGlmZiA9IChEYXRlLm5vdygpIC0gdGhpcy5fc3RhcnQpIC0gKHRoaXMuX3RpY2tzKysgKiB0aGlzLl9kZWxheSlcbiAgICAgICAgbGV0IGRlbGF5ID0gTWF0aC5tYXgoMCwgdGhpcy5fZGVsYXkgLSBkaWZmKVxuXG4gICAgICAgIC8vIGNsZWFyIG9sZCB0aW1lb3V0SURcbiAgICAgICAgdGhpcy5zdG9wKClcblxuICAgICAgICAvLyBjaGVjayBpZiB3ZSBoYXZlIHRpbWUgdG8gb25lIG1vcmUgdGlja1xuICAgICAgICBpZiAodGhpcy5oYXNUaW1lKGRlbGF5KSkge1xuICAgICAgICAgICAgdGhpcy5fdGltZW91dElkID0gc2V0VGltZW91dCh0aGlzLnRpY2suYmluZCh0aGlzKSwgZGVsYXkpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnN0b3BNYWluKClcbiAgICAgICAgICAgIGNvbnN0IHJlYXNvbiA9IHRoaXMubGFzdEVycm9yIHx8IG5ldyBFcnJvcihUSU1FT1VUX0VSUk9SKVxuICAgICAgICAgICAgdGhpcy5fcmVqZWN0KHJlYXNvbilcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGhhc1RpbWUgKGRlbGF5KSB7XG4gICAgICAgIHJldHVybiAoRGF0ZS5ub3coKSAtIHRoaXMuX3N0YXJ0ICsgZGVsYXkpIDw9IHRoaXMuX3RpbWVvdXRcbiAgICB9XG5cbiAgICB3YXNDb25kaXRpb25FeGVjdXRlZCAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jb25kaXRpb25FeGVjdXRlZENudCA+IDBcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRpbWVyXG4iXX0=