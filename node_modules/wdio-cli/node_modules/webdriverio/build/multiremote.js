"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash.zip"));

var _webdriver = require("webdriver");

var _config = require("@wdio/config");

var _middlewares = require("./middlewares");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Multiremote class
 */
class MultiRemote {
  constructor() {
    this.instances = {};
  }
  /**
   * add instance to multibrowser instance
   */


  async addInstance(browserName, client) {
    this.instances[browserName] = await client;
    return this.instances[browserName];
  }
  /**
   * modifier for multibrowser instance
   */


  modifier(wrapperClient) {
    const propertiesObject = {};
    propertiesObject.commandList = {
      value: wrapperClient.commandList
    };
    propertiesObject.options = {
      value: wrapperClient.options
    };

    for (const commandName of wrapperClient.commandList) {
      propertiesObject[commandName] = {
        value: this.commandWrapper(commandName)
      };
    }

    this.baseInstance = new MultiRemoteDriver(this.instances);
    const client = Object.create(this.baseInstance, propertiesObject);
    /**
     * attach instances to wrapper client
     */

    for (const [identifier, instance] of Object.entries(this.instances)) {
      client[identifier] = instance;
    }

    return client;
  }
  /**
   * helper method to generate element objects from results, so that we can call, e.g.
   *
   * ```
   * const elem = $('#elem')
   * elem.getHTML()
   * ```
   *
   * or in case multiremote is used
   *
   * ```
   * const elems = $$('div')
   * elems[0].getHTML()
   * ```
   */


  static elementWrapper(instances, result) {
    /**
     * we can't handle multi browser with different protocol support, therefor check only the
     * first registered browser and handle it similar to other browser
     */
    const isW3C = instances[Object.keys(instances)[0]].isW3C;
    const prototype = Object.assign((0, _webdriver.getPrototype)(isW3C), (0, _utils.getPrototype)('element'), {
      scope: 'element'
    });
    const element = (0, _webdriver.webdriverMonad)({}, client => {
      /**
       * attach instances to wrapper client
       */
      for (const [i, identifier] of Object.entries(Object.keys(instances))) {
        client[identifier] = result[i];
      }

      client.instances = Object.keys(instances);
      delete client.sessionId;
      return client;
    }, prototype);
    return element(this.sessionId, (0, _middlewares.multiremoteHandler)(_config.wrapCommand));
  }
  /**
   * handle commands for multiremote instances
   */


  commandWrapper(commandName) {
    const instances = this.instances;
    return (0, _config.wrapCommand)(commandName, async function (...args) {
      const result = await Promise.all(Object.entries(instances).map(([, instance]) => instance[commandName](...args)));
      /**
       * return element object to call commands directly
       */

      if (commandName === '$') {
        return MultiRemote.elementWrapper(instances, result);
      } else if (commandName === '$$') {
        const zippedResult = (0, _lodash.default)(...result);
        return zippedResult.map(singleResult => MultiRemote.elementWrapper(instances, singleResult));
      }

      return result;
    });
  }

}
/**
 * event listener class that propagates events to sub drivers
 */

/* istanbul ignore next */


exports.default = MultiRemote;

class MultiRemoteDriver {
  constructor(instances) {
    this.instances = Object.keys(instances);
    this.isMultiremote = true;
  }

  on(...args) {
    this.instances.forEach(instanceName => this[instanceName].on(...args));
  }

  once(...args) {
    this.instances.forEach(instanceName => this[instanceName].once(...args));
  }

  emit(...args) {
    this.instances.forEach(instanceName => this[instanceName].emit(...args));
  }

  eventNames(...args) {
    this.instances.forEach(instanceName => this[instanceName].eventNames(...args));
  }

  getMaxListeners() {
    this.instances.forEach(instanceName => this[instanceName].getMaxListeners());
  }

  listenerCount(...args) {
    this.instances.forEach(instanceName => this[instanceName].listenerCount(...args));
  }

  listeners(...args) {
    this.instances.forEach(instanceName => this[instanceName].listeners(...args));
  }

  removeListener(...args) {
    this.instances.forEach(instanceName => this[instanceName].removeListener(...args));
  }

  removeAllListeners(...args) {
    this.instances.forEach(instanceName => this[instanceName].removeAllListeners(...args));
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tdWx0aXJlbW90ZS5qcyJdLCJuYW1lcyI6WyJNdWx0aVJlbW90ZSIsImNvbnN0cnVjdG9yIiwiaW5zdGFuY2VzIiwiYWRkSW5zdGFuY2UiLCJicm93c2VyTmFtZSIsImNsaWVudCIsIm1vZGlmaWVyIiwid3JhcHBlckNsaWVudCIsInByb3BlcnRpZXNPYmplY3QiLCJjb21tYW5kTGlzdCIsInZhbHVlIiwib3B0aW9ucyIsImNvbW1hbmROYW1lIiwiY29tbWFuZFdyYXBwZXIiLCJiYXNlSW5zdGFuY2UiLCJNdWx0aVJlbW90ZURyaXZlciIsIk9iamVjdCIsImNyZWF0ZSIsImlkZW50aWZpZXIiLCJpbnN0YW5jZSIsImVudHJpZXMiLCJlbGVtZW50V3JhcHBlciIsInJlc3VsdCIsImlzVzNDIiwia2V5cyIsInByb3RvdHlwZSIsImFzc2lnbiIsInNjb3BlIiwiZWxlbWVudCIsImkiLCJzZXNzaW9uSWQiLCJ3cmFwQ29tbWFuZCIsImFyZ3MiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiemlwcGVkUmVzdWx0Iiwic2luZ2xlUmVzdWx0IiwiaXNNdWx0aXJlbW90ZSIsIm9uIiwiZm9yRWFjaCIsImluc3RhbmNlTmFtZSIsIm9uY2UiLCJlbWl0IiwiZXZlbnROYW1lcyIsImdldE1heExpc3RlbmVycyIsImxpc3RlbmVyQ291bnQiLCJsaXN0ZW5lcnMiLCJyZW1vdmVMaXN0ZW5lciIsInJlbW92ZUFsbExpc3RlbmVycyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7QUFFQTs7O0FBR2UsTUFBTUEsV0FBTixDQUFrQjtBQUM3QkMsRUFBQUEsV0FBVyxHQUFJO0FBQ1gsU0FBS0MsU0FBTCxHQUFpQixFQUFqQjtBQUNIO0FBRUQ7Ozs7O0FBR0EsUUFBTUMsV0FBTixDQUFtQkMsV0FBbkIsRUFBZ0NDLE1BQWhDLEVBQXdDO0FBQ3BDLFNBQUtILFNBQUwsQ0FBZUUsV0FBZixJQUE4QixNQUFNQyxNQUFwQztB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dCI6WyJpbXBvcnQgemlwIGZyb20gJ2xvZGFzaC56aXAnXG5pbXBvcnQgeyB3ZWJkcml2ZXJNb25hZCwgZ2V0UHJvdG90eXBlIGFzIGdldFdlYmRyaXZlclByb3RvdHlwZSB9IGZyb20gJ3dlYmRyaXZlcidcbmltcG9ydCB7IHdyYXBDb21tYW5kIH0gZnJvbSAnQHdkaW8vY29uZmlnJ1xuXG5pbXBvcnQgeyBtdWx0aXJlbW90ZUhhbmRsZXIgfSBmcm9tICcuL21pZGRsZXdhcmVzJ1xuaW1wb3J0IHsgZ2V0UHJvdG90eXBlIH0gZnJvbSAnLi91dGlscydcblxuLyoqXG4gKiBNdWx0aXJlbW90ZSBjbGFzc1xuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNdWx0aVJlbW90ZSB7XG4gICAgY29uc3RydWN0b3IgKCkge1xuICAgICAgICB0aGlzLmluc3RhbmNlcyA9IHt9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogYWRkIGluc3RhbmNlIHRvIG11bHRpYnJvd3NlciBpbnN0YW5jZVxuICAgICAqL1xuICAgIGFzeW5jIGFkZEluc3RhbmNlIChicm93c2VyTmFtZSwgY2xpZW50KSB7XG4gICAgICAgIHRoaXMuaW5zdGFuY2VzW2Jyb3dzZXJOYW1lXSA9IGF3YWl0IGNsaWVudFxuICAgICAgICByZXR1cm4gdGhpcy5pbnN0YW5jZXNbYnJvd3Nlck5hbWVdXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogbW9kaWZpZXIgZm9yIG11bHRpYnJvd3NlciBpbnN0YW5jZVxuICAgICAqL1xuICAgIG1vZGlmaWVyICh3cmFwcGVyQ2xpZW50KSB7XG4gICAgICAgIGNvbnN0IHByb3BlcnRpZXNPYmplY3QgPSB7fVxuICAgICAgICBwcm9wZXJ0aWVzT2JqZWN0LmNvbW1hbmRMaXN0ID0geyB2YWx1ZTogd3JhcHBlckNsaWVudC5jb21tYW5kTGlzdCB9XG4gICAgICAgIHByb3BlcnRpZXNPYmplY3Qub3B0aW9ucyA9IHsgdmFsdWU6IHdyYXBwZXJDbGllbnQub3B0aW9ucyB9XG5cbiAgICAgICAgZm9yIChjb25zdCBjb21tYW5kTmFtZSBvZiB3cmFwcGVyQ2xpZW50LmNvbW1hbmRMaXN0KSB7XG4gICAgICAgICAgICBwcm9wZXJ0aWVzT2JqZWN0W2NvbW1hbmROYW1lXSA9IHsgdmFsdWU6IHRoaXMuY29tbWFuZFdyYXBwZXIoY29tbWFuZE5hbWUpIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYmFzZUluc3RhbmNlID0gbmV3IE11bHRpUmVtb3RlRHJpdmVyKHRoaXMuaW5zdGFuY2VzKVxuICAgICAgICBjb25zdCBjbGllbnQgPSBPYmplY3QuY3JlYXRlKHRoaXMuYmFzZUluc3RhbmNlLCBwcm9wZXJ0aWVzT2JqZWN0KVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBhdHRhY2ggaW5zdGFuY2VzIHRvIHdyYXBwZXIgY2xpZW50XG4gICAgICAgICAqL1xuICAgICAgICBmb3IgKGNvbnN0IFtpZGVudGlmaWVyLCBpbnN0YW5jZV0gb2YgT2JqZWN0LmVudHJpZXModGhpcy5pbnN0YW5jZXMpKSB7XG4gICAgICAgICAgICBjbGllbnRbaWRlbnRpZmllcl0gPSBpbnN0YW5jZVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNsaWVudFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGhlbHBlciBtZXRob2QgdG8gZ2VuZXJhdGUgZWxlbWVudCBvYmplY3RzIGZyb20gcmVzdWx0cywgc28gdGhhdCB3ZSBjYW4gY2FsbCwgZS5nLlxuICAgICAqXG4gICAgICogYGBgXG4gICAgICogY29uc3QgZWxlbSA9ICQoJyNlbGVtJylcbiAgICAgKiBlbGVtLmdldEhUTUwoKVxuICAgICAqIGBgYFxuICAgICAqXG4gICAgICogb3IgaW4gY2FzZSBtdWx0aXJlbW90ZSBpcyB1c2VkXG4gICAgICpcbiAgICAgKiBgYGBcbiAgICAgKiBjb25zdCBlbGVtcyA9ICQkKCdkaXYnKVxuICAgICAqIGVsZW1zWzBdLmdldEhUTUwoKVxuICAgICAqIGBgYFxuICAgICAqL1xuICAgIHN0YXRpYyBlbGVtZW50V3JhcHBlciAoaW5zdGFuY2VzLCByZXN1bHQpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIHdlIGNhbid0IGhhbmRsZSBtdWx0aSBicm93c2VyIHdpdGggZGlmZmVyZW50IHByb3RvY29sIHN1cHBvcnQsIHRoZXJlZm9yIGNoZWNrIG9ubHkgdGhlXG4gICAgICAgICAqIGZpcnN0IHJlZ2lzdGVyZWQgYnJvd3NlciBhbmQgaGFuZGxlIGl0IHNpbWlsYXIgdG8gb3RoZXIgYnJvd3NlclxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgaXNXM0MgPSBpbnN0YW5jZXNbT2JqZWN0LmtleXMoaW5zdGFuY2VzKVswXV0uaXNXM0NcblxuICAgICAgICBjb25zdCBwcm90b3R5cGUgPSBPYmplY3QuYXNzaWduKGdldFdlYmRyaXZlclByb3RvdHlwZShpc1czQyksIGdldFByb3RvdHlwZSgnZWxlbWVudCcpLCB7IHNjb3BlOiAnZWxlbWVudCcgfSlcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IHdlYmRyaXZlck1vbmFkKHt9LCAoY2xpZW50KSA9PiB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIGF0dGFjaCBpbnN0YW5jZXMgdG8gd3JhcHBlciBjbGllbnRcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgZm9yIChjb25zdCBbaSwgaWRlbnRpZmllcl0gb2YgT2JqZWN0LmVudHJpZXMoT2JqZWN0LmtleXMoaW5zdGFuY2VzKSkpIHtcbiAgICAgICAgICAgICAgICBjbGllbnRbaWRlbnRpZmllcl0gPSByZXN1bHRbaV1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2xpZW50Lmluc3RhbmNlcyA9IE9iamVjdC5rZXlzKGluc3RhbmNlcylcbiAgICAgICAgICAgIGRlbGV0ZSBjbGllbnQuc2Vzc2lvbklkXG4gICAgICAgICAgICByZXR1cm4gY2xpZW50XG4gICAgICAgIH0sIHByb3RvdHlwZSlcblxuICAgICAgICByZXR1cm4gZWxlbWVudCh0aGlzLnNlc3Npb25JZCwgbXVsdGlyZW1vdGVIYW5kbGVyKHdyYXBDb21tYW5kKSlcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBoYW5kbGUgY29tbWFuZHMgZm9yIG11bHRpcmVtb3RlIGluc3RhbmNlc1xuICAgICAqL1xuICAgIGNvbW1hbmRXcmFwcGVyIChjb21tYW5kTmFtZSkge1xuICAgICAgICBjb25zdCBpbnN0YW5jZXMgPSB0aGlzLmluc3RhbmNlc1xuICAgICAgICByZXR1cm4gd3JhcENvbW1hbmQoY29tbWFuZE5hbWUsIGFzeW5jIGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgICAgICBPYmplY3QuZW50cmllcyhpbnN0YW5jZXMpLm1hcCgoWywgaW5zdGFuY2VdKSA9PiBpbnN0YW5jZVtjb21tYW5kTmFtZV0oLi4uYXJncykpXG4gICAgICAgICAgICApXG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogcmV0dXJuIGVsZW1lbnQgb2JqZWN0IHRvIGNhbGwgY29tbWFuZHMgZGlyZWN0bHlcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYgKGNvbW1hbmROYW1lID09PSAnJCcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gTXVsdGlSZW1vdGUuZWxlbWVudFdyYXBwZXIoaW5zdGFuY2VzLCByZXN1bHQpXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNvbW1hbmROYW1lID09PSAnJCQnKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgemlwcGVkUmVzdWx0ID0gemlwKC4uLnJlc3VsdClcbiAgICAgICAgICAgICAgICByZXR1cm4gemlwcGVkUmVzdWx0Lm1hcCgoc2luZ2xlUmVzdWx0KSA9PiBNdWx0aVJlbW90ZS5lbGVtZW50V3JhcHBlcihpbnN0YW5jZXMsIHNpbmdsZVJlc3VsdCkpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHRcbiAgICAgICAgfSlcbiAgICB9XG59XG5cbi8qKlxuICogZXZlbnQgbGlzdGVuZXIgY2xhc3MgdGhhdCBwcm9wYWdhdGVzIGV2ZW50cyB0byBzdWIgZHJpdmVyc1xuICovXG4vKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuY2xhc3MgTXVsdGlSZW1vdGVEcml2ZXIge1xuICAgIGNvbnN0cnVjdG9yIChpbnN0YW5jZXMpIHtcbiAgICAgICAgdGhpcy5pbnN0YW5jZXMgPSBPYmplY3Qua2V5cyhpbnN0YW5jZXMpXG4gICAgICAgIHRoaXMuaXNNdWx0aXJlbW90ZSA9IHRydWVcbiAgICB9XG5cbiAgICBvbiAoLi4uYXJncykge1xuICAgICAgICB0aGlzLmluc3RhbmNlcy5mb3JFYWNoKChpbnN0YW5jZU5hbWUpID0+IHRoaXNbaW5zdGFuY2VOYW1lXS5vbiguLi5hcmdzKSlcbiAgICB9XG5cbiAgICBvbmNlICguLi5hcmdzKSB7XG4gICAgICAgIHRoaXMuaW5zdGFuY2VzLmZvckVhY2goKGluc3RhbmNlTmFtZSkgPT4gdGhpc1tpbnN0YW5jZU5hbWVdLm9uY2UoLi4uYXJncykpXG4gICAgfVxuXG4gICAgZW1pdCAoLi4uYXJncykge1xuICAgICAgICB0aGlzLmluc3RhbmNlcy5mb3JFYWNoKChpbnN0YW5jZU5hbWUpID0+IHRoaXNbaW5zdGFuY2VOYW1lXS5lbWl0KC4uLmFyZ3MpKVxuICAgIH1cblxuICAgIGV2ZW50TmFtZXMgKC4uLmFyZ3MpIHtcbiAgICAgICAgdGhpcy5pbnN0YW5jZXMuZm9yRWFjaCgoaW5zdGFuY2VOYW1lKSA9PiB0aGlzW2luc3RhbmNlTmFtZV0uZXZlbnROYW1lcyguLi5hcmdzKSlcbiAgICB9XG5cbiAgICBnZXRNYXhMaXN0ZW5lcnMgKCkge1xuICAgICAgICB0aGlzLmluc3RhbmNlcy5mb3JFYWNoKChpbnN0YW5jZU5hbWUpID0+IHRoaXNbaW5zdGFuY2VOYW1lXS5nZXRNYXhMaXN0ZW5lcnMoKSlcbiAgICB9XG5cbiAgICBsaXN0ZW5lckNvdW50ICguLi5hcmdzKSB7XG4gICAgICAgIHRoaXMuaW5zdGFuY2VzLmZvckVhY2goKGluc3RhbmNlTmFtZSkgPT4gdGhpc1tpbnN0YW5jZU5hbWVdLmxpc3RlbmVyQ291bnQoLi4uYXJncykpXG4gICAgfVxuXG4gICAgbGlzdGVuZXJzICguLi5hcmdzKSB7XG4gICAgICAgIHRoaXMuaW5zdGFuY2VzLmZvckVhY2goKGluc3RhbmNlTmFtZSkgPT4gdGhpc1tpbnN0YW5jZU5hbWVdLmxpc3RlbmVycyguLi5hcmdzKSlcbiAgICB9XG5cbiAgICByZW1vdmVMaXN0ZW5lciAoLi4uYXJncykge1xuICAgICAgICB0aGlzLmluc3RhbmNlcy5mb3JFYWNoKChpbnN0YW5jZU5hbWUpID0+IHRoaXNbaW5zdGFuY2VOYW1lXS5yZW1vdmVMaXN0ZW5lciguLi5hcmdzKSlcbiAgICB9XG5cbiAgICByZW1vdmVBbGxMaXN0ZW5lcnMgKC4uLmFyZ3MpIHtcbiAgICAgICAgdGhpcy5pbnN0YW5jZXMuZm9yRWFjaCgoaW5zdGFuY2VOYW1lKSA9PiB0aGlzW2luc3RhbmNlTmFtZV0ucmVtb3ZlQWxsTGlzdGVuZXJzKC4uLmFyZ3MpKVxuICAgIH1cbn1cbiJdfQ==